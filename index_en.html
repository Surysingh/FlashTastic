<!DOCTYPE html>
<html lang="hi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="320">
    <title>English Grammar Flash game </title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+English&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>English Grammar Flash game</h1>
    <div id="menu">
        </div>

    <div id="settings-page" class="hidden">
        <h2>Settings</h2>
        <div class="settings-group">
            <label for="confetti-select">Confetti Variety</label>
            <select id="confetti-select">
                <option value="default">Default</option>
                <option value="sparkle">Sparkle</option>
                <option value="rainbow">Rainbow</option>
                <option value="stars">Stars</option>
            </select>
        </div>
        <div class="settings-group">
            <label for="font-size-range">Font Size (px)</label>
            <input type="range" id="font-size-range" min="12" max="36" value="24">
        </div>
        <div class="settings-group">
            <label for="button-size-range">Button Size (px)</label>
            <input type="range" id="button-size-range" min="12" max="36" value="18">
        </div>
        <div class="settings-group">
            <label for="animation-speed-range">Animation Speed (Multiplier)</label>
            <input type="range" id="animation-speed-range" min="0.5" max="2" step="0.1" value="1">
        </div>
        <div class="settings-group">
            <label>
                <input type="checkbox" id="toggle-scores" checked>
                Show Scores and High Scores
            </label>
        </div>
        <div class="settings-group">
            <label>
                <input type="checkbox" id="toggle-mistakes" checked>
                Show Mistakes in End Game
            </label>
        </div>
        <div class="settings-group">
            <label for="background-color-picker">Background Color</label>
            <input type="color" id="background-color-picker" value="#B22222">
        </div>
        <div class="settings-group">
            <label for="button-color-picker">Button Color</label>
            <input type="color" id="button-color-picker" value="#4caf50">
        </div>
        <div class="settings-group">
            <label>
                <input type="checkbox" id="toggle-translation">
                Show English to Hindi Translations
            </label>
        </div>

        <button id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        <button id="cancel-settings-btn" onclick="closeSettings()">Cancel</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="score">Score: 0</div>
        <div id="high-score">High Score: 0</div>
        <div id="message"></div>
        <div id="flashcard"></div>
        <div id="translation" class="hidden" style="font-size:18px; color:#555;"></div>
        <div id="options" class="options"></div>
        <div style="display: flex; justify-content: space-between;">
            <button id="summary-btn" onclick="summaryGame()">Summary</button>
            <button id="next-btn" class="hidden" onclick="nextFlashcard()">Next -></button>
        </div>
        <button id="exitGame-btn" class="hidden" onclick="exitGame()">Reset</button>
        <button id="continueGame-btn" onclick="endGame()">Continue</button>
        <div id="confetti-container"></div>
        <div id="summary" class="hidden"></div>
    </div>
	
<div id="flashcard-container">
    
    <button id="report-issue-btn" onclick="openReportIssueModal()">Report Issue</button>
     <button id="suggest-flashcard-btn" onclick="openSuggestFlashcardModal()">+</button>
</div>	

<div id="report-issue-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close" onclick="closeReportIssueModal()">&times;</span>
        <h2>Report a Flashcard Issue</h2>
        <p id="report-issue-question"></p>
        <form id="report-issue-form" action="" method="get" enctype="text/plain">
            <label for="issue-description">Describe the issue:</label>
            <textarea id="issue-description" name="issue-description" rows="4" required></textarea>
            <button type="submit">Send Email</button>
        </form>
    </div>
</div>

<div id="suggest-flashcard-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close" onclick="closeSuggestFlashcardModal()">&times;</span>
        <h2>Suggest a Flashcard</h2>
        <form id="suggest-flashcard-form" action="" method="get" enctype="text/plain">
            <label for="suggest-question">Question:</label>
            <input type="text" id="suggest-question" name="suggest-question" required>
            <label for="suggest-translation">Translation:</label>
            <input type="text" id="suggest-translation" name="suggest-translation">
            <label for="suggest-correct">Correct Answer:</label>
            <input type="text" id="suggest-correct" name="suggest-correct" required>
            <label for="suggest-options">Options (comma-separated):</label>
            <input type="text" id="suggest-options" name="suggest-options" required>
            <label for="suggest-grade">Grade:</label>
            <select id="suggest-grade" name="suggest-grade">
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>

            <button type="submit">Send Email</button>
        </form>
    </div>
</div>
   
</div>



    <script>
        // Global settings object â€“ updated via settings page
        let settings = {
            confettiType: 'default',
            fontSize: 24,
            buttonSize: 18,
            animationSpeed: 1,
            showScores: true,
            showMistakes: true,
            showTranslation: true,
            grade: 1
        };
		

        let categoryProgress = {};
        let categories = null;
		
       // Function to dynamically create category buttons
        function createCategoryButtons() {
            const menuDiv = document.getElementById("menu");
            if (categories) {
                // Get the category names directly from the 'categories' object's keys
                const categoryNames = Object.keys(categories);

                categoryNames.forEach((categoryName, index) => {
                    const button = document.createElement("button");
                    button.className = "menu-button";
                    button.textContent = `${index + 1}. ${categoryName}`;
                    button.onclick = function() {
                        selectCategory(categoryName);
                    };
                    menuDiv.appendChild(button);
                });
				                  const button = document.createElement("button");
                    button.className = "menu-button";
                    button.textContent = "Settings";
                    button.onclick = openSettings();
                    
                    menuDiv.appendChild(button);
					//document.getElementById("settings-page").classList.add("hidden");
					//document.getElementById("menu").classList.remove("hidden");
            } else {
                console.error("Categories data is not available.");
            }
			
  			
        }		

        // Initialize game after data is loaded
        function initGame() {
            if (typeof window.categories === 'undefined') {
                console.error('Categories data not loaded');
                return;
            }
            categories = window.categories;
            console.log(categories);
            console.log('Categories loaded successfully');
            createCategoryButtons();
        }

        // Load game when document is ready
        document.addEventListener('DOMContentLoaded', initGame);

 

        function selectCategory(categoryName) {
            if (currentCategory != categoryName) {
                if (!categories) {
                    alert("Game data is not loaded yet. Please try again.");
                    return;
                }

                let flashcards = categories[categoryName];
                if (!flashcards || flashcards.length === 0) {
                    alert("No flashcards available for this category.");
                    return;
                }

                currentCategory = categoryName;
                currentFlashcards = shuffle( /* flashcards.filter(card => !card.grade || card.grade == settings.grade) || */ flashcards);
                currentIndex = 0;

                document.getElementById("menu").classList.add("hidden");
                document.getElementById("game-container").classList.remove("hidden");
                document.getElementById("summary").classList.add("hidden");
                document.getElementById("exitGame-btn").classList.add("hidden");

                showFlashcard();
            } else {
                document.getElementById("menu").classList.add("hidden");
                document.getElementById("game-container").classList.remove("hidden");
                document.getElementById("summary").classList.add("hidden");
                document.getElementById("exitGame-btn").classList.add("hidden");

                nextFlashcard();
            }
        }

        // Current game state variables
        let currentCategory = null;
        let currentFlashcards = null;
        let currentIndex = 0;
        let score = 0;
        let highScore = localStorage.getItem('highScore') || 0;
        let mistakes = [];
		let currentCard = null; // Store the current flashcard


        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showFlashcard() {
		    
			
            let card = currentFlashcards[currentIndex];
			
			currentCard = card; // Store the card
			
            document.getElementById("flashcard").innerText = card.question;
			
			
            if (settings.showTranslation && card.Translation) {
                document.getElementById("translation").innerText = card.Translation;
                document.getElementById("translation").classList.remove("hidden");
            } else {
                document.getElementById("translation").classList.add("hidden");
            }
            let optionsDiv = document.getElementById("options");
            optionsDiv.innerHTML = "";
            const shuffledOptions = shuffle([...card.options]);
            shuffledOptions.forEach(opt => {
                let btn = document.createElement("button");
                btn.className = "option";
                btn.style.fontSize = settings.buttonSize + "px";
                btn.innerText = opt;
                btn.onclick = function() {
                    checkAnswer(opt);
                };
                optionsDiv.appendChild(btn);
            });
            document.getElementById("message").innerText = "";
            document.getElementById("next-btn").classList.add("hidden");
            document.getElementById("continueGame-btn").classList.add("hidden");
            document.getElementById("summary-btn").classList.remove("hidden");
            document.getElementById("flashcard").classList.remove("hidden");
            document.getElementById("options").classList.remove("hidden");
        }
		
    function openReportIssueModal() {
        if (!currentCard) return;  // Exit if no card

        document.getElementById("report-issue-question").innerText = currentCard.question;
        document.getElementById("report-issue-modal").style.display = "block";
    }

    function closeReportIssueModal() {
        document.getElementById("report-issue-modal").style.display = "none";
    }

    document.getElementById('report-issue-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent page reload

        const issueDescription = document.getElementById('issue-description').value;
        const issueTitle = `Issue with flashcard: ${currentCard.question}`; // Create a descriptive title

    // Sanitize input (basic example)
    const sanitizedDescription = issueDescription.replace(/</g, '&lt;').replace(/>/g, '&gt;');

    const question = currentCard.question;
    const translation = currentCard.Translation;
    const correct = currentCard.correct;
    const options = `${currentCard.options}`;
    const grade = currentCard.grade;
    const category =currentCategory;
    const recipient = "Kannada.1up@gmail.com";  // Replace with your email address

    // Basic input sanitization (consider more robust methods)
    const sanitizedQuestion = question.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const sanitizedTranslation = translation.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const sanitizedCorrect = correct.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const sanitizedOptions = options.replace(/</g, '&lt;').replace(/>/g, '&gt;');
	

    const emailTitle = `Flashcard Issue Report: ${question}`;
    const emailBody = `Issue Flashcard\n\n` +
                      `Question: ${sanitizedQuestion}\n` +
                      `Translation: ${sanitizedTranslation}\n` +
                      `Correct Answer: ${sanitizedCorrect}\n` +
                      `Options: ${sanitizedOptions}\n` +
                      `Grade: ${grade}\n` +
                      `Category: ${category}\n`+
                      `Description: ${sanitizedDescription}\n`;

    // Construct the mailto: link
   this.action = `mailto:${recipient}?subject=${emailTitle}&body=${encodeURIComponent(emailBody)}`;
//	    this.action = `mailto:${recipient}?subject={encodeURIComponent(emailTitle)}&body=${encodeURIComponent(emailBody)}`;


	

     // Programmatically trigger the <a> link
     window.location.href = this.action;
	 

    closeReportIssueModal();
       
    });

    function openSuggestFlashcardModal() {
	
        //console.log( openSuggestFlashcardModal )
		if (!currentCard) return;  // Exit if no card

        
        document.getElementById("suggest-flashcard-modal").style.display = "block";
        
    }

    function closeSuggestFlashcardModal() {
	//console.log( closeSuggestFlashcardModal )
        document.getElementById("suggest-flashcard-modal").style.display = "none";
    }

  document.getElementById('suggest-flashcard-form').addEventListener('submit', function(event) {
    event.preventDefault();
	
	

    const question = document.getElementById('suggest-question').value;
    const translation = document.getElementById('suggest-translation').value;
    const correct = document.getElementById('suggest-correct').value;
    const options = document.getElementById('suggest-options').value;
    const grade = document.getElementById('suggest-grade').value;
    const category =currentCategory;
    const recipient = "Kannada.1up@gmail.com";  // Replace with your email address

    // Basic input sanitization (consider more robust methods)
    const sanitizedQuestion = question.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const sanitizedTranslation = translation.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const sanitizedCorrect = correct.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const sanitizedOptions = options.replace(/</g, '&lt;').replace(/>/g, '&gt;');

    const emailTitle = `Flashcard Suggestion: ${question}`;
    const emailBody = `Suggested Flashcard\n\n` +
                      `Question: ${sanitizedQuestion}\n` +
                      `Translation: ${sanitizedTranslation}\n` +
                      `Correct Answer: ${sanitizedCorrect}\n` +
                      `Options: ${sanitizedOptions}\n` +
                      `Grade: ${grade}\n` +
                      `Category: ${category}`;

    // Construct the mailto: link
//    this.action = `mailto:<span class="math-inline">\{recipient\}?subject\=</span>{encodeURIComponent(emailTitle)}&body=${encodeURIComponent(emailBody)}`;
this.action = `mailto:${recipient}?subject=${emailTitle}&body=${encodeURIComponent(emailBody)}`;

console.log( this.action )
     // Programmatically trigger the <a> link
     window.location.href = this.action;
	 //console.log( this.action )
    closeSuggestFlashcardModal();
});

        function checkAnswer(selected) {
            let card = currentFlashcards[currentIndex];
            if (!categoryProgress[currentCategory]) {
                categoryProgress[currentCategory] = {
                    correct: 0,
                    total: 0
                };
            }
            categoryProgress[currentCategory].total++;

            if (selected === card.correct) {
                categoryProgress[currentCategory].correct++;
                score += 10;
                document.getElementById("message").innerText = "Correct!!!";
                triggerConfetti();
            } else {
                document.getElementById("message").innerText = "Wrong! Correct Answer: " + card.correct;

                let mistakeSound = new Audio('resources/mistake.mp3');
                mistakeSound.play();

        document.querySelectorAll('.option').forEach(btn => {
          btn.style.backgroundColor ="red";
          btn.style.color ="white";
        });
        
        mistakes.push({card: card, selected: selected});
            }
            updateScore();
            let optionButtons = document.getElementsByClassName("option");
            for (let btn of optionButtons) {
                btn.disabled = true;
                if (btn.innerText === card.correct) {
                    btn.classList.add("highlight-correct");
                }
            }
            document.getElementById("next-btn").classList.remove("hidden");
        }

        function updateScore() {
            if (settings.showScores) {
                document.getElementById("score").innerText = "Score: " + score;
                document.getElementById("high-score").innerText = "High Score: " + highScore;
            } else {
                document.getElementById("score").innerText = "";
                document.getElementById("high-score").innerText = "";
            }
        }

        function nextFlashcard() {
            currentIndex++;
            if (currentIndex < currentFlashcards.length) {
                showFlashcard();
            } else {
                summaryGame();
            }
        }

        function summaryGame() {
            if (score > highScore) highScore = score;

            let progress = categoryProgress[currentCategory];
            let diff = currentFlashcards.length - currentIndex - 1;
            let progressText = progress ?
                `Category Progress: ${progress.correct} / ${progress.total}` :
                'No progress tracked for this category.';
            let progressText2 = (currentIndex < currentFlashcards.length) ?
                `Remaining: ${diff}` :
                'All questions tried for this category';

            let summaryDiv = document.getElementById("summary");
            summaryDiv.innerHTML = "<h2>Game Summary </h2>" +
                (settings.showMistakes ? "<p>Mistakes: " + mistakes.length + "</p>" : "") +
                (mistakes.length ? "" : "<p>Amazing! You haven't made a mistake!!!</p>") +
                "<p>Current Category: " + currentCategory + "</p>" +
                "<p>" + progressText + "</p>" +
                "<p>" + progressText2 + "</p>" +
                "<h2> Email: Kannada.1up@gmail.com </h2>" +
                "<p><a href=\"https://github.com/Surysingh/Kannada.1up\">Collaborate to improve this game!!!</a></p>";

            summaryDiv.classList.remove("hidden");
            document.getElementById("continueGame-btn").classList.remove("hidden");
            document.getElementById("exitGame-btn").classList.remove("hidden");
            document.getElementById("next-btn").classList.add("hidden");
            document.getElementById("summary-btn").classList.add("hidden");
            document.getElementById("flashcard").classList.add("hidden");
            document.getElementById("options").classList.add("hidden");
        }

        function endGame() {
            updateScore();
            document.getElementById("game-container").classList.add("hidden");
            document.getElementById("menu").classList.remove("hidden");
        }

        function continueGame() {
            document.getElementById("game-container").classList.add("hidden");
            document.getElementById("menu").classList.remove("hidden");
        }

        function exitGame() {
            score = 0;
            mistakes = 0;
            currentCategory = null;
            categoryProgress = {};
            updateScore();
            document.getElementById("game-container").classList.add("hidden");
            document.getElementById("menu").classList.remove("hidden");
        }

        function triggerConfetti() {
            let container = document.getElementById("confetti-container");
            container.innerHTML = "";

            let chime = new Audio('resources/chime.mp3');
            chime.play();

            for (let i = 0; i < 30; i++) {
                let confetti = document.createElement("div");
                confetti.className = "confetti-piece";
                confetti.style.backgroundColor = (settings.confettiType === "rainbow") ?
                    getRandomColor() :
                    (settings.confettiType === "sparkle") ?
                    "#fff" : "#ff0000";
                confetti.style.left = Math.random() * 100 + "%";
                confetti.style.animationDuration = (1000 / settings.animationSpeed) + "ms";
                container.appendChild(confetti);
            }
            setTimeout(() => {
                container.innerHTML = "";
            }, 1500);
        }

        function getRandomColor() {
            let letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Settings page functions
        function openSettings() {
            document.getElementById("settings-page").classList.remove("hidden");
            document.getElementById("menu").classList.add("hidden");
        }

        function closeSettings() {
            document.getElementById("settings-page").classList.add("hidden");
            document.getElementById("menu").classList.remove("hidden");
        }

        function saveSettings() {
            settings.confettiType = document.getElementById("confetti-select").value;
            settings.fontSize = document.getElementById("font-size-range").value;
            settings.buttonSize = document.getElementById("button-size-range").value;
            settings.animationSpeed = parseFloat(document.getElementById("animation-speed-range").value);
            settings.showScores = document.getElementById("toggle-scores").checked;
            settings.showMistakes = document.getElementById("toggle-mistakes").checked;
            settings.showTranslation = document.getElementById("toggle-translation").checked;

            document.getElementById("flashcard").style.fontSize = settings.fontSize + "px";
            document.body.style.background = document.getElementById("background-color-picker").value;
            let btns = document.getElementsByClassName("menu-button");
            for (let btn of btns) {
                btn.style.backgroundColor = document.getElementById("button-color-picker").value;
            }
            closeSettings();
        }
    </script>

    <script src="resources/data_set_en.js"></script>
</body>

</html>